# Blockchain Integration

Simplified blockchain transaction configuration for Farcaster mini apps using wagmi and viem.

**Import Path**: `@/neynar-web-sdk/blockchain`

## Overview

This module provides a **zero-configuration blockchain provider** that handles most transaction use cases by automatically configuring chains, transports, and wallet connectors.

**Key Features**:
- Automatic HTTP transport configuration for each chain
- Default chain (Base) and connector (Farcaster Mini App)
- Support for multiple chains and custom connectors
- SSR-ready for Next.js applications
- Type-safe chain configurations

## Architecture

### Client-Side (React Components)
Use `NeynarWagmiProvider` with wagmi hooks for reactive UI:
```tsx
import { NeynarWagmiProvider } from '@/neynar-web-sdk/blockchain';
import { useAccount, useReadContract, useWriteContract } from 'wagmi';

<NeynarWagmiProvider>
  <YourApp />
</NeynarWagmiProvider>
```

### Server-Side (API Routes, Server Actions)
Use viem clients directly for blockchain calls:
```tsx
import { createPublicClient, http } from 'viem';
import { base } from 'viem/chains';

const publicClient = createPublicClient({
  chain: base,
  transport: http()
});
```

**Note**: Don't use wagmi actions on the server - just use viem directly for cleaner, more flexible code.

## Available Exports

### Core Provider

#### `NeynarWagmiProvider`
React provider that configures wagmi for blockchain interactions.

**Props**:
- `children` (ReactNode) - Your app components
- `chains?` ([ChainName, ...ChainName[]]) - Array of chain names (default: `["base", "mainnet"]`) - **DO NOT customize unless required**
- `connectors?` (Array<CreateConnectorFn>) - Wallet connectors (default: `[farcasterMiniApp()]`) - **DO NOT customize unless required**

**Note**: Use the default `<NeynarWagmiProvider>` with no props for most cases.

### Experimental Components

All blockchain transaction components are prefixed with "Experimental" to indicate they're in active development.

#### `ExperimentalUsdcBalance`
Displays USDC balance with flexible formatting options.

**Props**:
- `address` (Address) - Wallet address to check balance
- `showSymbol?` (boolean) - Show "USDC" symbol (default: false)
- `decimals?` (number) - Decimal places to display (default: 2)
- `asBadge?` (boolean) - Render as badge component (default: false)
- `variant?` - Badge variant (when asBadge=true)
- `className?` (string)

**Example**:
```tsx
import { ExperimentalUsdcBalance } from '@/neynar-web-sdk/blockchain';

// Simple balance
<ExperimentalUsdcBalance address="0x..." showSymbol decimals={2} />

// As badge
<ExperimentalUsdcBalance
  address="0x..."
  showSymbol
  asBadge
  variant="default"
/>
```

#### `ExperimentalTransferUsdcButton`
One-click USDC transfer button with transaction lifecycle handling.

**Props**:
- `to` (Address) - Recipient address
- `amountUsdc` (number) - Amount in USDC (human-readable)
- `children?` (ReactNode) - Button text
- `disabled?` (boolean)
- `onPending?` () => void - Called when user initiates transaction
- `onConfirming?` (hash: Address) => void - Called when transaction submitted
- `onSuccess?` (hash: Address) => void - Called when transaction confirmed
- `onError?` (error: Error) => void - Called on error
- `className?` (string)

**Example**:
```tsx
import { ExperimentalTransferUsdcButton } from '@/neynar-web-sdk/blockchain';

<ExperimentalTransferUsdcButton
  to="0xRecipient..."
  amountUsdc={10}
  onSuccess={(hash) => console.log('Sent!', hash)}
>
  Send 10 USDC
</ExperimentalTransferUsdcButton>
```

#### `ExperimentalTransferUsdcCard`
Complete USDC transfer card with recipient lookup and balance checking.

**Features**:
- Recipient by FID: Shows Farcaster profile (avatar, display name, username)
- Recipient by address: Shows ENS name if available
- Fallback chain: Farcaster user → ENS name → truncated address
- Balance checking with insufficient balance warnings
- Transaction status tracking

**Props**:
- `title?` (string) - Card title (default: "Send")
- `icon?` (LucideIcon) - Title icon (default: Send)
- `recipientFid?` (number | string) - Recipient Farcaster ID (displays user profile)
- `recipientAddress?` (Address) - Recipient wallet address (displays ENS or address)
- `amountUsdc?` (number) - Transfer amount in USDC (controlled, updates form when changed)
- `lockAmount?` (boolean) - Make amount field read-only (default: false)
- `onPending?`, `onConfirming?`, `onSuccess?`, `onError?` - Transaction lifecycle callbacks
- `className?` (string)

**Example**:
```tsx
import { ExperimentalTransferUsdcCard } from '@/neynar-web-sdk/blockchain';

// Transfer to Farcaster user (FID as number or string)
<ExperimentalTransferUsdcCard
  recipientFid={3}
  amountUsdc={10}
  onSuccess={(hash) => console.log('Sent!', hash)}
/>

// Transfer to wallet address with controlled amount
const [tipAmount, setTipAmount] = useState(5);
<ExperimentalTransferUsdcCard
  recipientAddress="0x..."
  amountUsdc={tipAmount}  // Updates form when changed
  lockAmount={true}
/>
```

#### `ExperimentalTransactionStatus`
Transaction confirmation status UI with loading, success, and error states.

**Props**:
- `hash?` (Address) - Transaction hash
- `showLink?` (boolean) - Show explorer link (default: true)
- `explorer?` ("basescan" | "etherscan" | "optimistic") - Block explorer (default: "basescan")
- `className?` (string)

**Example**:
```tsx
import { ExperimentalTransactionStatus } from '@/neynar-web-sdk/blockchain';

<ExperimentalTransactionStatus hash={txHash} explorer="basescan" />
```

#### `ExperimentalFarcasterIdInput`
Input field with live Farcaster user lookup and display.

**Props**:
- `value` (string) - Current FID value
- `onChange` (value: string) => void - Value change handler
- `onUserFound?` (user: User) => void - Called when valid user found
- `placeholder?` (string)
- `disabled?` (boolean)
- `id?` (string)
- `className?` (string)

**Example**:
```tsx
import { ExperimentalFarcasterIdInput } from '@/neynar-web-sdk/blockchain';

const [fid, setFid] = useState("");

<ExperimentalFarcasterIdInput
  value={fid}
  onChange={setFid}
  onUserFound={(user) => console.log(user.display_name)}
  placeholder="Enter FID..."
/>
```

### Utility Components

#### `ChainBadge`
Display blockchain network badge with icon (non-experimental).

**Props**:
- `chain` (ChainIdentifier) - Chain name, ID, or Chain object
- `variant?` - Badge variant
- `className?` (string)

**Example**:
```tsx
import { ChainBadge } from '@/neynar-web-sdk/blockchain';

<ChainBadge chain="base" />
<ChainBadge chain={8453} />
<ChainBadge chain={baseChain} />
```

**Examples**:

```tsx
// Recommended - uses defaults (Base chain + Farcaster connector)
<NeynarWagmiProvider>
  <YourApp />
</NeynarWagmiProvider>

// Only customize if explicitly needed (rare)
<NeynarWagmiProvider chains={["base", "ethereum", "optimism"]}>
  <YourApp />
</NeynarWagmiProvider>
```

### `ChainName`
Type union of supported chain names.

**Supported Chains**:
- `"base"` - Base mainnet
- `"base-sepolia"` - Base testnet
- `"ethereum"` - Ethereum mainnet
- `"sepolia"` - Ethereum testnet
- `"optimism"` - Optimism mainnet
- `"optimism-sepolia"` - Optimism testnet

### `farcasterSupportedChains`
Object mapping chain names to chain configurations.

```tsx
import { farcasterSupportedChains } from '@/neynar-web-sdk/blockchain';

const baseChain = farcasterSupportedChains.base.chain;
const baseName = farcasterSupportedChains.base.displayName;
```

## Usage Examples

### Basic Setup

```tsx
// src/app/layout.tsx or providers file
import { NeynarWagmiProvider } from '@/neynar-web-sdk/blockchain';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <NeynarWagmiProvider>
          {children}
        </NeynarWagmiProvider>
      </body>
    </html>
  );
}
```

### Reading Blockchain Data

```tsx
import { useAccount, useReadContract } from 'wagmi';

function TokenBalance() {
  const { address } = useAccount();

  const { data: balance } = useReadContract({
    address: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913', // USDC on Base
    abi: ERC20_ABI,
    functionName: 'balanceOf',
    args: [address],
  });

  return <div>Balance: {balance?.toString()}</div>;
}
```

### Writing Transactions

```tsx
import { useWriteContract, useWaitForTransactionReceipt } from 'wagmi';

function TransferButton() {
  const { writeContract, data: hash } = useWriteContract();

  const { isLoading: isConfirming } = useWaitForTransactionReceipt({ hash });

  const handleTransfer = () => {
    writeContract({
      address: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
      abi: ERC20_ABI,
      functionName: 'transfer',
      args: ['0xRecipient...', 1000000n], // 1 USDC (6 decimals)
    });
  };

  return (
    <button onClick={handleTransfer} disabled={isConfirming}>
      {isConfirming ? 'Confirming...' : 'Transfer'}
    </button>
  );
}
```

### Multi-Chain Support

```tsx
import { NeynarWagmiProvider } from '@/neynar-web-sdk/blockchain';
import { useAccount, useSwitchChain } from 'wagmi';

function App() {
  return (
    <NeynarWagmiProvider chains={["base", "ethereum", "optimism"]}>
      <ChainSwitcher />
    </NeynarWagmiProvider>
  );
}

function ChainSwitcher() {
  const { chain } = useAccount();
  const { switchChain } = useSwitchChain();

  return (
    <div>
      <p>Current: {chain?.name}</p>
      <button onClick={() => switchChain({ chainId: 8453 })}>Base</button>
      <button onClick={() => switchChain({ chainId: 1 })}>Ethereum</button>
      <button onClick={() => switchChain({ chainId: 10 })}>Optimism</button>
    </div>
  );
}
```

## Generated Contract Wrappers

The `contracts/` folder contains auto-generated TypeScript wrappers for smart contracts using the `@neynar/smart-contract-ts-generator` tool.

**Structure**:
```
contracts/
└── base/
    └── usdc/
        ├── abi.ts          # Contract ABI
        ├── hooks.ts        # React hooks (client-side)
        ├── client.ts       # Class wrapper (server-side)
        └── index.ts        # Exports
```

**Usage**:

```tsx
// Client-side with hooks
import { useUsdcBalanceOf, useUsdcTransfer } from '@/neynar-web-sdk/blockchain/contracts/base/usdc';

function USDCBalance() {
  const { address } = useAccount();
  const { data: balance } = useUsdcBalanceOf(
    '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
    address!
  );

  return <div>{balance?.toString()}</div>;
}

// Server-side with class
import { UsdcContract } from '@/neynar-web-sdk/blockchain/contracts/base/usdc';
import { createPublicClient, http } from 'viem';
import { base } from 'viem/chains';

const publicClient = createPublicClient({ chain: base, transport: http() });
const usdc = new UsdcContract(
  '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
  publicClient
);

const balance = await usdc.balanceOf('0x...');
```

## Technical Details

### What the Provider Does Automatically

1. **Maps chain names to viem Chain objects**
   ```tsx
   "base" → baseChain from viem/chains
   ```

2. **Creates HTTP transports for each chain**
   ```tsx
   { [chainId]: http() }
   ```

3. **Configures wagmi with SSR support**
   ```tsx
   createConfig({ chains, transports, connectors, ssr: true })
   ```

### What You DON'T Need to Worry About

- ✅ Transport configuration (HTTP, WebSocket, etc.)
- ✅ Chain object lookups and imports
- ✅ SSR hydration issues
- ✅ Type assertions for wagmi's tuple types
- ✅ RPC endpoint URLs (uses chain defaults)

## Best Practices

### ✅ DO

- Use `NeynarWagmiProvider` at the root of your app with NO props (default config)
- Use wagmi hooks (`useReadContract`, `useWriteContract`) in React components
- Use viem clients directly in server actions and API routes
- Use generated contract wrappers from `contracts/` folder

### ❌ DON'T

- Don't use wagmi actions (`readContract`, `writeContract` from wagmi/actions) on the server
- Don't create multiple `NeynarWagmiProvider` instances unless you need different configs
- Don't manually configure chains or transports - use the defaults
- Don't import viem chain objects when you can use chain names

## Related Documentation

- [wagmi Documentation](https://wagmi.sh)
- [viem Documentation](https://viem.sh)
- [Farcaster Mini App Connector](https://github.com/farcasterxyz/miniapp-wagmi-connector)
- [Smart Contract TypeScript Generator](https://github.com/neynarxyz/smart-contract-ts-generator)
